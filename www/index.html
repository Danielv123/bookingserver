<!DOCTYPE html>
<html>
<head>
<script language="JavaScript" type="text/javascript" src="moment.min.js">
</script>
<script language="JavaScript" type="text/javascript" src="jquery-3.3.1.min.js">
</script>
<style>
table#t01{
	width: 100%;
	color: white;
	border: 1px solid gray;
	border-collapse: collapse;
}
table#t01 th, tr{
	padding: 7px;
	width: 50%;
	text-align: middle;
	background-color: green;
}

</style>
<title>Ã…ssiden Booking System</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta http-equiv="refresh" content="300";>
</head>
<body style="margin:0px;">



<h1 style="color:white;text-align:center;background-color:gray;padding:20px;"><B>Booking for rom Anode 136<B></h1>


<p id="Username"></p>
<input type="text" name="LoginCode" id="LoginCode" value="123">
<button onclick="loginFunction()" id="LoginButton">Login</button>
<button onclick="document.location = document.location" id="RefreshButton">Refresh</button>

<div style="background-color:white;color:white;">.</div>
<table id="t01">
	<tr>
		<th style="background-color: gray;">Tid</th>
		<th style="background-color: gray;">Status  </th>
	</tr>
	<tr class="timeSlot">
		<th id="table7301">07:30</th>
		<th id="table7302">Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>08:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>08:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>09:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>09:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>10:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>10:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>11:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>11:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>12:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>12:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>13:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>13:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>14:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>14:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>15:00</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>15:30</th>
		<th>Ledig</th>
	</tr>
	<tr class="timeSlot">
		<th>16:00</th>
		<th>Ledig</th>
	</tr>
</table>

<script>
var timeSlots = document.querySelectorAll(".timeSlot");
for(var i = 0; i < timeSlots.length; i++){
	timeSlots[i].onclick = statusChangeFunction;
}

function statusChangeFunction(){
	if (!document.getElementById("Username").innerHTML == ""){
		if(this.childNodes[3].innerHTML == "Booket av " + document.getElementById("Username").innerHTML){
			this.childNodes[1].style.backgroundColor = "green";
			this.childNodes[3].style.backgroundColor = "green";
			this.childNodes[3].innerHTML = "Ledig";
		var settings = {
			"url": "/api/unbook",
			"method": "POST",
			"timeout": 0,
			"headers": {
				"Content-Type": "application/json"
			},
			"data": JSON.stringify({PIN: Number(document.getElementById("LoginCode").value),
				from: moment(this.childNodes[1].innerHTML, "HH:mm").toDate(),
			}),
		};
		$.ajax(settings).done(function (response) {
			console.log(response);
		});
		}else if (this.childNodes[3].innerHTML == "Ledig") {
			var settings = {
			"url": "/api/booking",
			"method": "POST",
			"timeout": 0,
			"headers": {
				"Content-Type": "application/json"
			},
			"data": JSON.stringify({name: document.getElementById("Username").innerHTML,
				pass: document.getElementById("LoginCode").value,
				room: "Anode",
				from: moment(this.childNodes[1].innerHTML, "HH:mm").toDate(),
				to: moment(this.childNodes[1].innerHTML, "HH:mm").add(30, "minutes").toDate()
			}),
			};
			$.ajax(settings).done(function (response) {
				console.log(response);
			});
			this.childNodes[1].style.backgroundColor = "#eeee17";
			this.childNodes[3].style.backgroundColor = "#eeee17";
			this.childNodes[3].innerHTML = "Booket av " + document.getElementById("Username").innerHTML;
		}
	}
}
function loginFunction(){
	var settings = {
	"url": "/api/users",
	"method": "GET",
	"timeout": 0,
	};
	$.get("/api/users", function(data){
		if (document.getElementById("LoginCode").value == "123"){
			document.getElementById("Username").innerHTML = "Anders";
			document.getElementById("LoginButton").style.display = "none";
			document.getElementById("LoginCode").style.display = "none";
		}
	});
}
var settings = {
	"url": "/api/rooms",
	"method": "GET",
	"timeout": 0,
};
$.get( "/api/rooms", function(data) {
	for(var i = 0; i < data[0].booking.length; i++){
		for(var i2 = 0; i2 < timeSlots.length; i2++){
			if(moment().subtract(30, "minutes").format("HH:mm") >= timeSlots[i2].childNodes[1].innerHTML){
				timeSlots[i2].style.display = "none";
			}
		// use HH with capital letters (24h vs 12h) and mm with small letters (00 vs 01)
			if(moment(data[0].booking[i].from).format("HH:mm") == timeSlots[i2].childNodes[1].innerHTML){
				var compareDate = moment().format();
				var startDate = moment(data[0].booking[i].from).format();
				var endDate = moment(data[0].booking[i].to).format();
				if(compareDate <= endDate && compareDate >= startDate){
					timeSlots[i2].childNodes[1].style.backgroundColor = "Crimson";
					timeSlots[i2].childNodes[3].style.backgroundColor = "Crimson";
					timeSlots[i2].childNodes[3].innerHTML = "Opptatt";
					console.log(data[0]);
				}else{
					timeSlots[i2].childNodes[1].style.backgroundColor = "#eeee17";
					timeSlots[i2].childNodes[3].style.backgroundColor = "#eeee17";
					timeSlots[i2].childNodes[3].innerHTML = "Booket av " + data[0].booking[i].name;
				}
			}
		}
	}
});
</script>
</body>

</html>